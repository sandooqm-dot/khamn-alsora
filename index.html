<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>لعبة تخمين الصور</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#5b2a74;
      --bg2:#3f1b56;
      --card:#6f4b86;
      --card2:#6b4583;
      --stroke:#0d0d0d;
      --white:#fff;
      --shadow: rgba(0,0,0,.25);
      --btnBlue:#7da9b4;
      --btnBrown:#5a220f;
      --btnGreen:#10c45b;
      --btnGreen2:#0fb054;
      --btnYellow:#f4c400;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:"Baloo Bhaijaan 2", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% -150px, #8b6aa3 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 26px 14px calc(22px + env(safe-area-inset-bottom));
      color:var(--white);
    }

    .wrap{
      width:min(540px, 100%);
      background: rgba(255,255,255,.10);
      border-radius: 26px;
      padding: 18px 16px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }

    .logo{
      position:absolute;
      top: 10px;
      left: 12px;
      width: 86px;
      height: 86px;
      object-fit:contain;
      pointer-events:none;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }

    h1{
      margin: 66px 0 18px;
      text-align:center;
      font-size: clamp(36px, 6.6vw, 54px);
      font-weight: 900;
      letter-spacing:.5px;
      text-shadow:
        0 3px 0 rgba(0,0,0,.35),
        0 10px 20px rgba(0,0,0,.18);
    }

    .frame{
      margin: 0 auto 18px;
      width: min(470px, 100%);
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.12));
      border-radius: 22px;
      padding: 18px 14px 16px;
      border: 5px solid rgba(0,0,0,.65);
      box-shadow: inset 0 10px 20px rgba(0,0,0,.18);
    }

    .label{
      text-align:center;
      font-size: 34px;
      font-weight: 900;
      margin: 4px 0 10px;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
    }

    .in{
      width:100%;
      height: 62px;
      border-radius: 18px;
      border: 4px solid rgba(0,0,0,.70);
      background: #f2f2f2;
      padding: 0 16px;
      font-size: 28px;
      font-weight: 800;
      text-align:center;
      color:#4b4b4b;
      outline:none;
      box-shadow: inset 0 8px 16px rgba(0,0,0,.10);
    }
    .in::placeholder{color:#9a9a9a;font-weight:800}

    .spacer{height:14px}

    .subLabel{
      text-align:center;
      font-size: 32px;
      font-weight: 900;
      margin: 2px 0 10px;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
    }

    .row{
      display:flex;
      gap: 14px;
      justify-content:center;
      margin-top: 8px;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-family:inherit;
      font-weight: 900;
      font-size: 30px;
      padding: 14px 22px;
      border-radius: 18px;
      min-width: 160px;
      box-shadow: 0 10px 0 rgba(0,0,0,.25), 0 18px 30px rgba(0,0,0,.18);
      border: 4px solid rgba(0,0,0,.75);
      transition: transform .06s ease;
    }
    .btn:active{transform: translateY(2px)}
    .btn-blue{background: var(--btnBlue); color:#fff}
    .btn-brown{background: var(--btnBrown); color:#fff}

    .startWrap{
      display:flex;
      justify-content:center;
      margin: 18px 0 10px;
    }

    /* ✅ زر ابدأ اللعب: أصغر + بيضاوي مثل الصورة */
    .btnStart{
      background: linear-gradient(180deg, var(--btnGreen), var(--btnGreen2));
      color:#fff;
      border: 4px solid rgba(0,0,0,.75);
      box-shadow: 0 10px 0 rgba(0,0,0,.25), 0 18px 30px rgba(0,0,0,.18);
      font-size: 40px;
      font-weight: 900;
      padding: 14px 44px;
      border-radius: 999px; /* بيضاوي */
      cursor:pointer;
      min-width: 240px;
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
    }
    .btnStart:active{transform: translateY(2px)}
    .btnStart[disabled]{
      opacity:.55;
      filter: grayscale(25%);
      cursor:not-allowed;
    }

    .buyBtn{
      display:block;
      margin: 10px auto 12px;
      background: linear-gradient(180deg, #ffd34d, var(--btnYellow));
      color:#111;
      text-decoration:none;
      text-align:center;
      font-weight: 900;
      font-size: 30px;
      padding: 14px 18px;
      border-radius: 999px;
      width: min(430px, 100%);
      border: 4px solid rgba(0,0,0,.75);
      box-shadow: 0 10px 0 rgba(0,0,0,.25), 0 18px 30px rgba(0,0,0,.18);
    }

    .note{
      text-align:center;
      margin-top: 2px;
      font-size: 18px;
      opacity:.85;
      font-weight:700;
    }

    /* ✅ الحقوق: أصغر + سطر واحد + أسفل المربع */
    .footer{
      text-align:center;
      font-size: 18px;
      font-weight: 800;
      opacity:.95;
      margin-top: 8px;
      white-space: nowrap;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(520px, 100%);
      background: #ffffff;
      color:#111;
      border-radius: 18px;
      padding: 16px 14px 14px;
      border: 4px solid rgba(0,0,0,.75);
      box-shadow: 0 25px 60px rgba(0,0,0,.35);
    }
    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .modalTitle{
      font-weight: 900;
      font-size: 22px;
    }
    .closeBtn{
      border:none;
      background:#eee;
      font-weight:900;
      border-radius: 10px;
      padding: 8px 10px;
      cursor:pointer;
    }
    .linkBox{
      width:100%;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 700;
      direction:ltr;
      text-align:left;
      background:#fafafa;
    }
    .copyRow{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .copyBtn{
      flex:1;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 12px 10px;
      font-weight: 900;
      font-size: 18px;
      background: #1f4fa3;
      color:#fff;
    }
    .qrWrap{
      display:none;
      margin-top: 12px;
      text-align:center;
    }
    canvas{max-width:100%}
    .tiny{
      margin-top: 8px;
      font-size: 13px;
      opacity:.8;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <img class="logo" src="logo.PNG" alt="صندوق المسابقات">

    <h1>لعبة تخمين الصور</h1>

    <div class="frame">
      <div class="label">اللاعب الأول</div>
      <input id="p1" class="in" type="text" placeholder="اكتب اسمك هنا.." autocomplete="off" />

      <div class="spacer"></div>

      <div class="subLabel">اللاعب الثاني</div>
      <input id="p2" class="in" type="text" placeholder="بانتظار انضمام اللاعب الثاني..." readonly />
      
      <div class="spacer"></div>

      <div class="subLabel">طرق مشاركة اللاعبين</div>
      <div class="row">
        <button id="btnQR" class="btn btn-blue" type="button">باركود</button>
        <button id="btnLink" class="btn btn-brown" type="button">رابط</button>
      </div>
    </div>

    <div class="startWrap">
      <button id="btnStart" class="btnStart" disabled>ابدأ اللعب</button>
    </div>

    <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
  </div>

  <!-- Modal -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal">
      <div class="modalTop">
        <div id="modalTitle" class="modalTitle">مشاركة الرابط</div>
        <button id="closeModal" class="closeBtn" type="button">إغلاق</button>
      </div>

      <input id="shareLink" class="linkBox" readonly />

      <div class="copyRow">
        <button id="copyBtn" class="copyBtn" type="button">نسخ الرابط</button>
      </div>

      <div id="qrWrap" class="qrWrap">
        <canvas id="qrCanvas"></canvas>
      </div>

      <div class="tiny">انسخ الرابط أو امسح الباركود من جهاز اللاعب الثاني</div>
    </div>
  </div>

  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script type="module">
    // =========================
    // Firebase (نفس مشروع برا السالفة)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDYxoP7QEy3ShH_KOTx19jqj3IbWGTEOd0",
      authDomain: "bara-alsalfah-eu.firebaseapp.com",
      projectId: "bara-alsalfah-eu",
      storageBucket: "bara-alsalfah-eu.firebasestorage.app",
      messagingSenderId: "657928540352",
      appId: "1:657928540352:web:dcf15096ac8501326e9d25",
      measurementId: "G-HKJGX94BJD"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // =========================
    // Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function genRoomId(){
      // 6 أرقام
      return String(Math.floor(100000 + Math.random() * 900000));
    }

    function buildJoinLink(roomId){
      // رابط join.html بنفس المسار
      const here = new URL(window.location.href);
      here.search = "";
      const basePath = here.pathname.endsWith("/") ? here.pathname : here.pathname.replace(/\/[^\/]*$/, "/");
      const joinUrl = new URL(basePath + "join.html", window.location.origin);
      joinUrl.searchParams.set("room", roomId);
      return joinUrl.toString();
    }

    // =========================
    // UI Elements
    // =========================
    const p1 = $("p1");
    const p2 = $("p2");
    const btnStart = $("btnStart");
    const btnQR = $("btnQR");
    const btnLink = $("btnLink");

    const overlay = $("overlay");
    const closeModal = $("closeModal");
    const modalTitle = $("modalTitle");
    const shareLinkInput = $("shareLink");
    const copyBtn = $("copyBtn");
    const qrWrap = $("qrWrap");
    const qrCanvas = $("qrCanvas");

    function openModal(mode){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");

      if(mode === "qr"){
        modalTitle.textContent = "باركود المشاركة";
        qrWrap.style.display = "block";
        // رسم QR
        QRCode.toCanvas(qrCanvas, shareLinkInput.value, { width: 260 }, (err)=>{});
      }else{
        modalTitle.textContent = "رابط المشاركة";
        qrWrap.style.display = "none";
      }
    }
    function close(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }
    closeModal.addEventListener("click", close);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) close(); });

    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(shareLinkInput.value);
        copyBtn.textContent = "تم النسخ ✅";
        setTimeout(()=> copyBtn.textContent = "نسخ الرابط", 900);
      }catch(e){
        // fallback
        shareLinkInput.select();
        document.execCommand("copy");
        copyBtn.textContent = "تم النسخ ✅";
        setTimeout(()=> copyBtn.textContent = "نسخ الرابط", 900);
      }
    });

    // =========================
    // Room logic (Host)
    // =========================
    const roomId = genRoomId();
    const roomRef = doc(db, "khamnRooms", roomId);
    const joinLink = buildJoinLink(roomId);

    shareLinkInput.value = joinLink;

    // Create room doc
    await setDoc(roomRef, {
      roomId,
      createdAt: serverTimestamp(),
      status: "lobby",
      player1Name: "",
      player2Name: "",
      startedAt: null
    }, { merge: true });

    // Listen updates
    onSnapshot(roomRef, (snap)=>{
      if(!snap.exists()) return;
      const data = snap.data() || {};

      // تحديث اسم اللاعب الثاني
      const n2 = (data.player2Name || "").trim();
      if(n2){
        p2.value = n2;
        btnStart.disabled = false;
      }else{
        p2.value = "";
        p2.placeholder = "بانتظار انضمام اللاعب الثاني...";
        btnStart.disabled = true;
      }

      // إذا بدأ اللعب (احتياط)
      if(data.status === "playing"){
        const url = new URL("game.html", window.location.href);
        url.searchParams.set("room", roomId);
        url.searchParams.set("role", "host");
        window.location.href = url.toString();
      }
    });

    // حفظ اسم اللاعب الأول
    let nameTimer = null;
    p1.addEventListener("input", ()=>{
      clearTimeout(nameTimer);
      nameTimer = setTimeout(async ()=>{
        const n1 = (p1.value || "").trim();
        await updateDoc(roomRef, { player1Name: n1 });
      }, 250);
    });

    // Share buttons
    btnLink.addEventListener("click", ()=> openModal("link"));
    btnQR.addEventListener("click", ()=> openModal("qr"));

    // Start
    btnStart.addEventListener("click", async ()=>{
      const n1 = (p1.value || "").trim();
      if(!n1){
        p1.focus();
        return;
      }
      await updateDoc(roomRef, {
        status: "playing",
        startedAt: serverTimestamp()
      });
      const url = new URL("game.html", window.location.href);
      url.searchParams.set("room", roomId);
      url.searchParams.set("role", "host");
      window.location.href = url.toString();
    });

  </script>
</body>
</html>

<!--
اسم النسخة: index.html (خمن الصورة) – إصدار 1
-->
