<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>لعبة تخمين الصور</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#6b3b85;
      --bg2:#4c1563;
      --card:#4b0e67;
      --card2:#5a1678;
      --white:#ffffff;
      --black:#000000;
      --shadow:rgba(0,0,0,.35);
      --green:#17c45a;
      --teal:#76a8b1;
      --brown:#7a2a14;
      --yellow:#f5c400;
      --muted:rgba(255,255,255,.65);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Baloo Bhaijaan 2", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 50% 10%, var(--bg) 0%, var(--bg2) 70%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px calc(24px + env(safe-area-inset-bottom));
      color:#fff;
    }

    .screen{
      width:min(520px, 96vw);
      background: rgba(255,255,255,.08);
      border-radius:34px;
      padding:18px 18px 20px;
      box-shadow:0 18px 40px var(--shadow);
      position:relative;
    }

    .logo{
      position:absolute;
      top:14px;
      left:14px;
      width:92px;
      height:auto;
      pointer-events:none;
      user-select:none;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }

    .title{
      text-align:center;
      margin:64px 0 16px;
      font-size:56px;
      line-height:1;
      font-weight:900;
      color:#f2f2f2;
      text-shadow:
        0 4px 0 rgba(0,0,0,.35),
        0 0 0 rgba(0,0,0,.0);
      letter-spacing:.2px;
    }

    .panel{
      margin:10px auto 18px;
      width:min(460px, 92%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.12));
      border:5px solid #000;
      border-radius:26px;
      padding:18px 16px;
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
    }

    .label{
      text-align:center;
      font-size:38px;
      font-weight:900;
      margin:2px 0 6px;
    }

    .inputWrap{
      margin:6px 0 14px;
      display:flex;
      justify-content:center;
    }

    input{
      width:min(380px, 96%);
      height:64px;
      border-radius:22px;
      border:4px solid #000;
      outline:none;
      background:#f6f6f6;
      padding:0 18px;
      font-size:26px;
      font-weight:800;
      text-align:center;
      color:#222;
      box-shadow: inset 0 4px 0 rgba(0,0,0,.08);
    }
    input::placeholder{
      color:#8d8d8d;
      font-weight:800;
    }

    .nameBox{
      width:min(380px, 96%);
      height:64px;
      border-radius:22px;
      border:4px solid #000;
      background:#f6f6f6;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#1e1e1e;
      font-size:26px;
      font-weight:900;
      box-shadow: inset 0 4px 0 rgba(0,0,0,.08);
      margin:0 auto 8px;
    }

    .nameBox.muted{
      color:#8d8d8d;
      font-weight:800;
    }

    .shareTitle{
      text-align:center;
      font-size:36px;
      font-weight:900;
      margin:12px 0 10px;
    }

    .shareRow{
      display:flex;
      gap:14px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:4px;
    }

    .btn{
      border:4px solid #000;
      border-radius:22px;
      height:62px;
      padding:0 26px;
      font-size:30px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.22);
      transition: transform .08s ease, filter .08s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(2px); filter:brightness(.98); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; filter:grayscale(.2); }

    .btnLink{ background:var(--brown); color:#fff; }
    .btnQR{ background:var(--teal); color:#fff; }

    .startWrap{
      display:flex;
      justify-content:center;
      margin:18px 0 4px;
    }

    .btnStart{
      background:var(--green);
      color:#fff;
      width:min(300px, 70%);
      height:72px;
      border-radius:24px;
      font-size:40px;
      font-weight:900;
      box-shadow: 0 12px 0 rgba(0,0,0,.22);
    }

    .footer{
      text-align:center;
      margin-top:10px;
      color:rgba(255,255,255,.92);
      font-weight:800;
      font-size:18px;
      text-shadow: 0 3px 0 rgba(0,0,0,.25);
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(520px, 96vw);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.12));
      border:5px solid #000;
      border-radius:26px;
      padding:16px 14px 14px;
      color:#fff;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{
      font-size:28px;
      font-weight:900;
      margin:0;
    }
    .close{
      background:rgba(255,255,255,.14);
      color:#fff;
      border:3px solid #000;
      width:46px;
      height:46px;
      border-radius:14px;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
    }

    .qrWrap{
      display:flex;
      justify-content:center;
      margin:8px 0 12px;
    }
    #qr{
      background:#fff;
      padding:10px;
      border-radius:16px;
      border:4px solid #000;
    }

    .linkBox{
      background:rgba(255,255,255,.10);
      border:4px solid #000;
      border-radius:18px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:center;
    }
    .linkText{
      direction:ltr;
      background:#fff;
      color:#111;
      border:3px solid #000;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      max-width:100%;
      overflow:auto;
      font-size:14px;
    }
    .btnCopy{
      background:var(--yellow);
      color:#111;
      height:52px;
      font-size:24px;
      border-radius:18px;
      padding:0 18px;
    }

    .hint{
      text-align:center;
      color:var(--muted);
      font-weight:800;
      margin-top:10px;
      font-size:16px;
    }
  </style>
</head>
<body>

  <div class="screen">
    <img class="logo" src="logo.PNG" alt="صندوق المسابقات">

    <div class="title">لعبة تخمين الصور</div>

    <div class="panel">
      <div class="label">اللاعب الأول</div>
      <div class="inputWrap">
        <input id="hostName" type="text" placeholder="اكتب اسمك هنا.." autocomplete="off" maxlength="18">
      </div>

      <div class="label">اللاعب الثاني</div>
      <div id="guestBox" class="nameBox muted">بانتظار انضمام اللاعب الثاني...</div>

      <div class="shareTitle">طرق مشاركة اللاعبين</div>
      <div class="shareRow">
        <button id="btnLink" class="btn btnLink" type="button">رابط</button>
        <button id="btnQR" class="btn btnQR" type="button">باركود</button>
      </div>
    </div>

    <div class="startWrap">
      <button id="btnStart" class="btn btnStart" type="button" disabled>ابدأ اللعب</button>
    </div>

    <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
  </div>

  <!-- Modal -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle" class="modalTitle">مشاركة رابط اللعبة</h3>
        <button id="btnClose" class="close" type="button">✕</button>
      </div>

      <div id="qrWrap" class="qrWrap" style="display:none;">
        <div id="qr"></div>
      </div>

      <div class="linkBox">
        <div id="joinLink" class="linkText">...</div>
        <button id="btnCopy" class="btn btnCopy btnCopy" type="button">نسخ</button>
      </div>

      <div class="hint">شارك الرابط أو الباركود مع اللاعب الثاني للدخول.</div>
    </div>
  </div>

  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ firebaseConfig (نفس مشروع برا السالفة)
    const firebaseConfig = {
      apiKey: "AIzaSyDYxoP7QEy3ShH_KOTx19jqj3IbWGTEOd0",
      authDomain: "bara-alsalfah-eu.firebaseapp.com",
      projectId: "bara-alsalfah-eu",
      storageBucket: "bara-alsalfah-eu.firebasestorage.app",
      messagingSenderId: "657928540352",
      appId: "1:657928540352:web:dcf15096ac8501326e9d25",
      measurementId: "G-HKJGX94BJD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✅ مسار مستقل للعبة تخمين الصور
    const ROOMS_PATH = "khamnRooms";

    const hostNameEl = document.getElementById("hostName");
    const guestBoxEl = document.getElementById("guestBox");
    const btnLink = document.getElementById("btnLink");
    const btnQR = document.getElementById("btnQR");
    const btnStart = document.getElementById("btnStart");

    const overlay = document.getElementById("overlay");
    const btnClose = document.getElementById("btnClose");
    const modalTitle = document.getElementById("modalTitle");
    const joinLinkEl = document.getElementById("joinLink");
    const btnCopy = document.getElementById("btnCopy");
    const qrWrap = document.getElementById("qrWrap");
    const qrEl = document.getElementById("qr");

    let roomId = sessionStorage.getItem("khamn_roomId") || "";
    let unsub = null;
    let latestJoinUrl = "";

    function genRoomId(){
      // 6 أرقام (مناسب لرولزك)
      const n = Math.floor(100000 + Math.random() * 900000);
      return String(n);
    }

    function baseUrl(){
      // نفس مجلد المشروع في GitHub Pages
      return window.location.href.replace(/[^\/]*$/, "");
    }

    function buildJoinUrl(id){
      return baseUrl() + "join.html?room=" + encodeURIComponent(id);
    }

    function setGuestName(name){
      if(name && String(name).trim()){
        guestBoxEl.classList.remove("muted");
        guestBoxEl.textContent = String(name).trim();
      }else{
        guestBoxEl.classList.add("muted");
        guestBoxEl.textContent = "بانتظار انضمام اللاعب الثاني...";
      }
    }

    function canStart(){
      const h = hostNameEl.value.trim();
      const g = !guestBoxEl.classList.contains("muted") && guestBoxEl.textContent.trim();
      btnStart.disabled = !(h && g);
    }

    async function ensureRoom(){
      const hName = hostNameEl.value.trim();
      if(!hName){
        hostNameEl.focus();
        return false;
      }

      if(!roomId){
        roomId = genRoomId();
        sessionStorage.setItem("khamn_roomId", roomId);
      }

      const ref = doc(db, ROOMS_PATH, roomId);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        await setDoc(ref, {
          createdAt: serverTimestamp(),
          game: "khamn-alsora",
          status: "lobby",
          hostName: hName,
          guestName: "",
          startedAt: null
        });
      }else{
        // حدّث اسم المقدم فقط (بدون لعب بالبيانات الثانية)
        await updateDoc(ref, { hostName: hName });
      }

      listenRoom();
      latestJoinUrl = buildJoinUrl(roomId);
      joinLinkEl.textContent = latestJoinUrl;

      return true;
    }

    function listenRoom(){
      if(unsub) unsub();
      if(!roomId) return;

      const ref = doc(db, ROOMS_PATH, roomId);
      unsub = onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;

        const data = snap.data() || {};
        const hostName = (data.hostName || "").toString();
        const guestName = (data.guestName || "").toString();
        const status = (data.status || "").toString();

        // لا نغصب المستخدم، بس لو فاضي وداخلنا من جديد
        if(!hostNameEl.value.trim() && hostName){
          hostNameEl.value = hostName;
        }

        setGuestName(guestName);
        canStart();

        // لو بدأ اللعب (احتياط)
        if(status === "started"){
          window.location.href = "game.html?room=" + encodeURIComponent(roomId) + "&role=host";
        }
      });
    }

    function openModal(mode){
      overlay.classList.add("show");
      if(mode === "qr"){
        modalTitle.textContent = "مشاركة باركود اللعبة";
        qrWrap.style.display = "flex";
        qrEl.innerHTML = "";
        // QR
        new QRCode(qrEl, {
          text: latestJoinUrl,
          width: 180,
          height: 180
        });
      }else{
        modalTitle.textContent = "مشاركة رابط اللعبة";
        qrWrap.style.display = "none";
      }
    }

    function closeModal(){
      overlay.classList.remove("show");
    }

    // أحداث
    btnClose.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

    btnCopy.addEventListener("click", async ()=>{
      if(!latestJoinUrl) return;
      try{
        await navigator.clipboard.writeText(latestJoinUrl);
        btnCopy.textContent = "تم النسخ";
        setTimeout(()=> btnCopy.textContent = "نسخ", 900);
      }catch{
        // fallback بسيط
        const ta = document.createElement("textarea");
        ta.value = latestJoinUrl;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        btnCopy.textContent = "تم النسخ";
        setTimeout(()=> btnCopy.textContent = "نسخ", 900);
      }
    });

    btnLink.addEventListener("click", async ()=>{
      const ok = await ensureRoom();
      if(!ok) return;
      openModal("link");
    });

    btnQR.addEventListener("click", async ()=>{
      const ok = await ensureRoom();
      if(!ok) return;
      openModal("qr");
    });

    hostNameEl.addEventListener("input", ()=>{
      // ما نفعّل ابدأ اللعب إلا بعد انضمام الثاني
      canStart();
    });

    hostNameEl.addEventListener("blur", async ()=>{
      // لما يكتب اسمه ونطلع من الحقل: ننشئ الغرفة تلقائياً
      if(hostNameEl.value.trim()){
        await ensureRoom();
      }
    });

    btnStart.addEventListener("click", async ()=>{
      const ok = await ensureRoom();
      if(!ok) return;

      const ref = doc(db, ROOMS_PATH, roomId);
      await updateDoc(ref, {
        status: "started",
        startedAt: serverTimestamp()
      });

      window.location.href = "game.html?room=" + encodeURIComponent(roomId) + "&role=host";
    });

    // لو رجعنا للصفحة وفيه roomId محفوظ
    (async function boot(){
      if(roomId){
        // لو موجودة غرفة سابقة، اربط الاستماع
        listenRoom();
        latestJoinUrl = buildJoinUrl(roomId);
        joinLinkEl.textContent = latestJoinUrl;
      }
    })();
  </script>
</body>
</html>

<!-- اسم النسخة: index.html (خمن الصورة) – إصدار 1 -->
