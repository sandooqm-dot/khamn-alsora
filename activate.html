<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>تفعيل لعبة تخمين الصور</title>

  <style>
    :root{
      --bg1:#123a7a;
      --bg2:#1f4fa3;
      --card:rgba(255,255,255,.10);
      --frame:rgba(255,255,255,.18);
      --white:#fff;
      --black:#0b0b0b;
      --gold:#f4c400;
      --gold2:#ffd64a;
      --danger:#ff5b5b;
      --ok:#21c55d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% 25%, #2a63c8 0%, var(--bg2) 45%, var(--bg1) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
      color:var(--white);
    }
    .wrap{
      width:min(520px, 94vw);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px;
      padding:22px 16px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    .inner{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.18);
      border-radius:20px;
      padding:18px 14px 16px;
      text-align:center;
    }
    .logo{
      width:64px;height:64px; object-fit:contain;
      margin:4px auto 10px;
      display:block;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      pointer-events:none;
      user-select:none;
    }
    h1{
      margin:0 0 16px;
      font-size:34px;
      line-height:1.2;
      font-weight:900;
      text-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .card{
      margin:0 auto;
      width:min(420px, 94%);
      background:#f2f2f2;
      border:4px solid #0f0f0f;
      border-radius:16px;
      padding:14px 12px 14px;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.12), 0 12px 30px rgba(0,0,0,.20);
      color:var(--black);
    }
    .label{
      font-size:18px;
      font-weight:800;
      margin:0 0 10px;
    }
    input{
      width:100%;
      height:54px;
      border-radius:14px;
      border:3px solid #1b1b1b;
      outline:none;
      font-size:22px;
      font-weight:900;
      text-align:center;
      letter-spacing:1px;
      padding:0 12px;
      background:#fff;
    }
    .btn{
      width:100%;
      height:58px;
      border-radius:14px;
      border:3px solid #1b1b1b;
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      font-size:26px;
      font-weight:900;
      margin-top:12px;
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.22);
      color:#1565c0;
    }
    .btn:disabled{
      opacity:.65;
      cursor:not-allowed;
      filter:saturate(.7);
    }
    .msg{
      margin-top:14px;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      font-weight:900;
      padding:10px 12px;
      background:#fff;
      border:0;
      color:#111;
    }
    .msg.ok{ background: #eafff2; color:#0f7a37; border:2px solid rgba(33,197,93,.35); }
    .msg.bad{ background: #fff1f1; color:#b00020; border:2px solid rgba(255,91,91,.35); }

    .overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .overlay.show{ display:flex; }
    .toast{
      background:#fff;
      color:#111;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
    }

    .footer{
      margin-top:14px;
      font-size:14px;
      opacity:.85;
      color:#e9f1ff;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="inner">
      <!-- ✅ اللوقو (أنت تقول محلوله، خليته موجود) -->
      <img class="logo" src="logo.png" alt="صندوق المسابقات" />

      <h1>تفعيل لعبة تخمين الصور</h1>

      <div class="card">
        <div class="label">أدخل كود التفعيل</div>
        <input id="code" placeholder="SNDQ-XXXX-XXXX-XXXX" autocomplete="off" autocapitalize="characters" />
        <button id="btn" class="btn">تفعيل</button>

        <div id="msg" class="msg bad" style="opacity:.65">
          أدخل الكود ثم اضغط تفعيل
        </div>
      </div>

      <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
    </div>

    <div id="overlay" class="overlay">
      <div class="toast">جاري التحقق من الكود…</div>
    </div>
  </div>

  <script>
    /**************
     * عدّل هذا السطر فقط:
     **************/
    const SCRIPT_URL = "PUT_YOUR_EXEC_URL_HERE"; // مثال: https://script.google.com/macros/s/XXXX/exec

    // وين يروح بعد التفعيل؟ (غيّرها إذا تبغى)
    const NEXT_URL = "index.html";

    const elCode = document.getElementById("code");
    const elBtn  = document.getElementById("btn");
    const elMsg  = document.getElementById("msg");
    const overlay= document.getElementById("overlay");

    let busy = false;
    let timeoutId = null;
    let lastScriptTag = null;

    function setMsg(text, ok){
      elMsg.textContent = text;
      elMsg.className = "msg " + (ok ? "ok" : "bad");
      elMsg.style.opacity = "1";
    }

    function showLoading(on){
      overlay.classList.toggle("show", !!on);
      elBtn.disabled = !!on;
      busy = !!on;
    }

    function normalizeCode(v){
      return String(v || "")
        .trim()
        .toUpperCase()
        .replace(/\s+/g,"")
        .replace(/—/g,"-");
    }

    function getDeviceKey(){
      const k = "sandooq_device_key_v1";
      let v = localStorage.getItem(k);
      if (!v){
        // ثابت للجهاز/المتصفح
        v = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("dv-" + Math.random().toString(16).slice(2) + Date.now());
        localStorage.setItem(k, v);
      }
      return v;
    }

    function cleanup(){
      if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }
      if (lastScriptTag) {
        lastScriptTag.remove();
        lastScriptTag = null;
      }
    }

    // ✅ JSONP call (يحل تعليق Safari/CORS)
    function jsonp(url, cbName){
      return new Promise((resolve, reject) => {
        window[cbName] = (data) => {
          cleanup();
          try { delete window[cbName]; } catch(e){}
          resolve(data);
        };

        const s = document.createElement("script");
        s.src = url;
        s.onerror = () => {
          cleanup();
          try { delete window[cbName]; } catch(e){}
          reject(new Error("network_error"));
        };

        lastScriptTag = s;
        document.body.appendChild(s);

        // ✅ تايم آوت يمنع التعليق للأبد
        timeoutId = setTimeout(() => {
          cleanup();
          try { delete window[cbName]; } catch(e){}
          reject(new Error("timeout"));
        }, 10000);
      });
    }

    async function activate(){
      if (busy) return;

      const code = normalizeCode(elCode.value);
      if (!code){
        setMsg("اكتب الكود أولاً", false);
        return;
      }

      showLoading(true);
      setMsg("جاري التحقق…", false);

      const device = getDeviceKey();
      const cbName = "__cb_" + Math.random().toString(36).slice(2);

      // رابط JSONP
      const url = SCRIPT_URL
        + "?code=" + encodeURIComponent(code)
        + "&device=" + encodeURIComponent(device)
        + "&callback=" + encodeURIComponent(cbName)
        + "&_=" + Date.now(); // منع كاش

      try{
        const res = await jsonp(url, cbName);

        if (res && res.ok){
          // خزّن أنه مفعل
          localStorage.setItem("sandooq_activated_v1", "1");
          localStorage.setItem("sandooq_code_v1", code);

          setMsg("✅ تم التفعيل", true);
          showLoading(false);

          // ✅ تحويل تلقائي للعبة
          setTimeout(() => {
            window.location.href = NEXT_URL;
          }, 450);

        } else {
          const err = (res && (res.error || res.msg)) ? (res.error || res.msg) : "لم يتم التفعيل";
          setMsg("❌ " + err, false);
          showLoading(false);
        }

      } catch(e){
        // هذا اللي كان يصير عندك (تعليق) — الحين يصير رسالة واضحة
        if (String(e && e.message) === "timeout") {
          setMsg("❌ تعذر التحقق الآن (انتهت المهلة). جرّب مره ثانية.", false);
        } else {
          setMsg("❌ تعذر التحقق الآن. تأكد من رابط السكربت /exec والإنترنت.", false);
        }
        showLoading(false);
      }
    }

    elBtn.addEventListener("click", activate);
    elCode.addEventListener("keydown", (e) => {
      if (e.key === "Enter") activate();
    });
  </script>
</body>
</html>
