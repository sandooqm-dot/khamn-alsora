<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تفعيل لعبة تخمين الصور</title>

  <style>
    :root{
      --bg1:#0f2f6f;
      --bg2:#143a86;
      --card:#ffffff;
      --frame:#0b2b63;
      --shadow:rgba(0,0,0,.25);
      --yellow:#f4c400;
      --yellow2:#ffd55a;
      --text:#111;
      --muted:#6b7280;
      --danger:#d12b2b;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, sans-serif;
      min-height:100vh;
      background: radial-gradient(1200px 800px at 50% 20%, #1c4fb3 0%, var(--bg2) 45%, var(--bg1) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
      color:#fff;
    }
    .outer{
      width:min(460px, 92vw);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:26px;
      padding:18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .inner{
      background: rgba(20,58,134,.45);
      border-radius:22px;
      padding:18px 18px 20px;
      position:relative;
    }
    .logoWrap{
      display:flex;
      justify-content:center;
      margin-top:4px;
      margin-bottom:8px;
    }
    .logo{
      width:74px;height:74px;
      object-fit:contain;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.25));
    }
    h1{
      margin:6px 0 14px;
      text-align:center;
      font-size:34px;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 6px 16px rgba(0,0,0,.25);
      line-height:1.1;
    }
    .card{
      background: var(--card);
      border-radius:18px;
      padding:16px;
      border:4px solid #111;
      box-shadow: 0 12px 24px var(--shadow);
      color:var(--text);
    }
    .label{
      text-align:center;
      font-size:22px;
      font-weight:800;
      margin-bottom:10px;
    }
    input{
      width:100%;
      padding:14px 14px;
      font-size:22px;
      font-weight:900;
      border-radius:14px;
      border:3px solid #111;
      outline:none;
      text-align:center;
      letter-spacing:1px;
      box-shadow: inset 0 2px 0 rgba(0,0,0,.08);
    }
    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      font-size:26px;
      font-weight:900;
      border-radius:14px;
      border:3px solid #111;
      background: linear-gradient(180deg, var(--yellow2), var(--yellow));
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.25);
      transition: transform .08s ease;
    }
    .btn:active{ transform: translateY(2px); box-shadow: 0 8px 0 rgba(0,0,0,.22); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .statusBox{
      margin-top:12px;
      min-height:38px;
      border-radius:12px;
      padding:10px 12px;
      background:#f3f4f6;
      color: var(--muted);
      border:1px solid #e5e7eb;
      font-weight:700;
      text-align:center;
    }
    .statusBox.ok{ color: var(--ok); background:#ecfdf5; border-color:#bbf7d0; }
    .statusBox.bad{ color: var(--danger); background:#fef2f2; border-color:#fecaca; }
    .hint{
      margin-top:10px;
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.75);
    }
    .footer{
      margin-top:10px;
      text-align:center;
      font-size:13px;
      color: rgba(255,255,255,.85);
    }
  </style>
</head>

<body>
  <div class="outer">
    <div class="inner">
      <div class="logoWrap">
        <!-- إذا عندك logo.png بالمستودع خله كذا -->
        <img class="logo" src="logo.png" alt="صندوق المسابقات" onerror="this.style.display='none'">
      </div>

      <h1>تفعيل لعبة تخمين الصور</h1>

      <div class="card">
        <div class="label">أدخل كود التفعيل</div>

        <input id="code" placeholder="SNDQ-XXXX-XXXX-XXXX" autocomplete="off" autocapitalize="characters" />

        <button id="btn" class="btn">تفعيل</button>

        <div id="msg" class="statusBox">جاهز</div>
      </div>

      <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
      <div class="hint" id="debug"></div>
    </div>
  </div>

<script>
  // ✅ حط رابط السكربت هنا (Web App /exec)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlWNNceDPOcOTwwsDJTTca7qIu-5tDSKtOsMUAXvfANa7uW4YW40fFAp5gAkuTuAU_DQ/exec";

  const elCode = document.getElementById("code");
  const elBtn  = document.getElementById("btn");
  const elMsg  = document.getElementById("msg");
  const elDbg  = document.getElementById("debug");

  function setMsg(text, type){
    elMsg.textContent = text;
    elMsg.className = "statusBox" + (type ? " " + type : "");
  }

  function cleanCode(s){
    return String(s||"")
      .trim()
      .toUpperCase()
      .replace(/\s+/g,'')
      .replace(/[^\w\-]/g,'');
  }

  function getDeviceId(){
    // جهاز ثابت (مثل سباق الحروف): يتخزن في localStorage
    const key = "sandooq_device_id_v1";
    let v = localStorage.getItem(key);
    if(!v){
      if (crypto && crypto.randomUUID) v = crypto.randomUUID();
      else v = "dev-" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      localStorage.setItem(key, v);
    }
    return v;
  }

  // ✅ JSONP helper (بدون CORS)
  function jsonp(url, params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(16).slice(2);
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      const qs = new URLSearchParams({ ...params, callback: cb }).toString();
      const script = document.createElement("script");
      script.src = url + (url.includes("?") ? "&" : "?") + qs;
      script.onerror = () => { cleanup(); reject(new Error("network")); };
      document.body.appendChild(script);
    });
  }

  async function activate(){
    const code = cleanCode(elCode.value);
    if(!code){
      setMsg("اكتب الكود أولاً", "bad");
      return;
    }

    elBtn.disabled = true;
    setMsg("جاري التحقق من الكود...", "");
    elDbg.textContent = "";

    const deviceId = getDeviceId();

    try{
      const res = await jsonp(SCRIPT_URL, {
        action: "verify",
        code,
        deviceId
      });

      // Debug صغير (مفيد لو فيه خطأ)
      // elDbg.textContent = JSON.stringify(res);

      if(res && res.ok){
        setMsg("تم التفعيل ✅", "ok");
        // حط هنا التحويل لصفحة اللعبة بعد التفعيل (إذا عندك)
        // مثال:
        // window.location.href = "index.html";
      }else{
        const err = (res && res.error) ? res.error : "تعذر التحقق الآن";
        setMsg(err, "bad");
      }
    }catch(e){
      // هذا اللي كان يسبب لك “تعذر التحقق…” بسبب CORS/شبكة
      setMsg("تعذر التحقق الآن. تأكد من الإنترنت أو رابط السكربت.", "bad");
      elDbg.textContent = "ERR: " + (e && e.message ? e.message : e);
    }finally{
      elBtn.disabled = false;
    }
  }

  elBtn.addEventListener("click", activate);
  elCode.addEventListener("keydown", (e) => { if(e.key === "Enter") activate(); });
</script>
</body>
</html>
