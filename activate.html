<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>تفعيل لعبة تخمين الصور</title>

  <style>
    :root{
      --bg1:#0f3f8f;
      --bg2:#1f5fb6;
      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.16);
      --text:#ffffff;
      --muted: rgba(255,255,255,.65);
      --yellow:#f4c400;
      --yellow2:#ffdd55;
      --black:#111;
      --ok:#18b26a;
      --bad:#ff4d4d;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 50% 20%, #2d66c9 0%, var(--bg2) 35%, var(--bg1) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
    }

    .frame{
      width:min(520px, 96vw);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 28px;
      padding:22px 18px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .inner{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 26px;
      padding:20px 18px 18px;
    }

    .logoWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      margin:2px 0 8px;
    }
    .logo{
      width:86px;
      height:86px;
      object-fit:contain;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.28));
    }

    h1{
      margin:10px 0 12px;
      text-align:center;
      font-size:34px;
      letter-spacing:.2px;
      line-height:1.1;
      font-weight:900;
    }

    .card{
      background: rgba(255,255,255,.85);
      border-radius: 18px;
      padding:18px;
      color:#111;
      border: 3px solid rgba(0,0,0,.75);
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
    }

    .label{
      text-align:center;
      font-weight:900;
      font-size:20px;
      margin:0 0 10px;
    }

    .codeInput{
      width:100%;
      border: 3px solid rgba(0,0,0,.75);
      border-radius: 14px;
      padding:14px 14px;
      font-size:20px;
      font-weight:900;
      text-align:center;
      outline:none;
      letter-spacing:2px;
      text-transform:uppercase;
      background:#fff;
    }

    .btn{
      width:100%;
      margin-top:12px;
      border:none;
      border-radius: 14px;
      padding:14px 14px;
      font-size:22px;
      font-weight:900;
      background: linear-gradient(180deg, var(--yellow2) 0%, var(--yellow) 100%);
      color:#0b3f8c;
      cursor:pointer;
      box-shadow: 0 12px 20px rgba(0,0,0,.22);
      border: 3px solid rgba(0,0,0,.65);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .status{
      margin-top:12px;
      border-radius: 12px;
      padding:10px 12px;
      font-weight:800;
      text-align:center;
      display:none;
    }
    .status.ok{
      display:block;
      background: rgba(24,178,106,.12);
      border:1px solid rgba(24,178,106,.35);
      color:#0c7a48;
    }
    .status.bad{
      display:block;
      background: rgba(255,77,77,.10);
      border:1px solid rgba(255,77,77,.35);
      color:#b10f0f;
    }
    .status.wait{
      display:block;
      background: rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.12);
      color:#222;
    }

    .foot{
      margin-top:14px;
      text-align:center;
      font-size:13px;
      color: var(--muted);
    }

    /* Loading overlay */
    .overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
      backdrop-filter: blur(3px);
    }
    .overlay .pill{
      background: rgba(255,255,255,.92);
      color:#111;
      padding:12px 14px;
      border-radius: 12px;
      font-weight:900;
      border:1px solid rgba(0,0,0,.15);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="overlay" id="overlay">
      <div class="pill" id="overlayText">جاري التحقق من الكود...</div>
    </div>

    <div class="inner">
      <div class="logoWrap">
        <!-- مهم: عندك الملف غالباً اسمه logo.PNG -->
        <img class="logo" src="logo.PNG" alt="صندوق المسابقات">
      </div>

      <h1>تفعيل لعبة تخمين الصور</h1>

      <div class="card">
        <div class="label">أدخل كود التفعيل</div>
        <input id="code" class="codeInput" placeholder="SNDQ-XXXX-XXXX-XXXX" inputmode="latin" autocomplete="off" />
        <button id="btn" class="btn" disabled>تفعيل</button>

        <div id="msg" class="status"></div>
      </div>

      <div class="foot">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
    </div>
  </div>

<script>
  /***********************
   * إعدادات مهمة
   ***********************/
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlWNNceDPOcOTwwsDJTTca7qIu-5tDSKtOsMUAXvfANa7uW4YW40fFAp5gAkuTuAU_DQ/exec";
  const NEXT_PAGE  = "index.html";     // غيّرها لو لعبتك تفتح صفحة ثانية
  const GAME_KEY   = "guess_images_v1";// مفتاح داخلي للعبة (لا تغيّره)

  /***********************/
  const elCode = document.getElementById("code");
  const elBtn  = document.getElementById("btn");
  const elMsg  = document.getElementById("msg");
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");

  // لو متفعل من قبل -> ادخل اللعبة مباشرة
  if (localStorage.getItem("SANDOQ_ACTIVATED_" + GAME_KEY) === "1") {
    location.replace(NEXT_PAGE);
  }

  function show(type, text){
    elMsg.className = "status " + type;
    elMsg.textContent = text;
  }
  function setLoading(on, text){
    overlay.style.display = on ? "flex" : "none";
    if (text) overlayText.textContent = text;
  }

  function normalizeCode(v){
    v = (v || "").toUpperCase().replace(/[^A-Z0-9]/g, "");
    if (!v.startsWith("SNDQ")) {
      // لو كتب بدون SNDQ نخليه عادي
    }
    // شكل: SNDQ-XXXX-XXXX-XXXX
    // نجبره: 4 + 4 + 4 + 4
    const parts = [];
    parts.push(v.slice(0,4));
    if (v.length > 4) parts.push(v.slice(4,8));
    if (v.length > 8) parts.push(v.slice(8,12));
    if (v.length > 12) parts.push(v.slice(12,16));
    return parts.filter(Boolean).join("-");
  }

  function isValid(code){
    return /^SNDQ-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/.test(code);
  }

  function getDeviceKey(){
    // ثابت للجهاز/المتصفح
    let k = localStorage.getItem("SANDOQ_DEVICEKEY");
    if (!k){
      // بسيط وعملي (ممتاز لمتطلباتك)
      k = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
      localStorage.setItem("SANDOQ_DEVICEKEY", k);
    }
    return k;
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });
    return await res.json();
  }

  async function getJSON(url, params){
    const q = new URLSearchParams(params).toString();
    const res = await fetch(url + (url.includes("?") ? "&" : "?") + q, { method:"GET" });
    return await res.json();
  }

  async function activate(){
    const code = elCode.value.trim();
    if (!isValid(code)){
      show("bad", "الكود غير صحيح. تأكد من الصيغة.");
      return;
    }

    setLoading(true, "جاري التحقق من الكود...");
    show("wait", "جاري التحقق...");

    const deviceKey = getDeviceKey();
    const payload = { code, deviceId: deviceKey, deviceKey };

    try{
      // نجرب POST أولاً
      let data;
      try{
        data = await postJSON(SCRIPT_URL, payload);
      }catch(e){
        // لو POST انرفض نجرب GET
        data = await getJSON(SCRIPT_URL, payload);
      }

      if (data && data.ok === true){
        // حفظ التفعيل
        localStorage.setItem("SANDOQ_ACTIVATED_" + GAME_KEY, "1");
        localStorage.setItem("SANDOQ_CODE_" + GAME_KEY, code);
        show("ok", "✅ تم التفعيل");

        // تحويل للعبة
        setLoading(true, "جارٍ فتح اللعبة...");
        setTimeout(() => location.replace(NEXT_PAGE), 600);
        return;
      }

      const err = (data && (data.error || data.msg)) ? (data.error || data.msg) : "تعذر التحقق. تأكد من الإنترنت أو رابط السكربت.";
      show("bad", "❌ " + err);
      setLoading(false);

    }catch(err){
      show("bad", "❌ تعذر التحقق الآن. تأكد من الإنترنت أو رابط السكربت.");
      setLoading(false);
    }
  }

  elCode.addEventListener("input", () => {
    const v = normalizeCode(elCode.value);
    elCode.value = v;
    elBtn.disabled = !isValid(v);
    elMsg.style.display = "none";
  });

  elBtn.addEventListener("click", activate);

  // Enter
  elCode.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !elBtn.disabled) activate();
  });
</script>
</body>
</html>
