<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تفعيل اللعبة</title>
  <style>
    :root{
      --bg:#0f3f9b;
      --card:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.14);
      --white:#fff;
      --black:#111;
      --yellow1:#ffd54a;
      --yellow2:#f4c400;
      --danger:#ff4d4d;
      --ok:#2ecc71;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh;
      background: radial-gradient(circle at 50% 30%, #1b63d4 0%, var(--bg) 60%, #0a2d72 100%);
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      color:var(--white);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .wrap{
      width:min(520px, 94vw);
      background: linear-gradient(180deg, var(--card2), var(--card));
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      padding:22px 18px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
    }
    .logo{
      width:84px;height:84px; object-fit:contain;
      display:block; margin:0 auto 10px;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
    }
    h1{
      margin:8px 0 14px;
      text-align:center;
      font-size:34px;
      letter-spacing:.2px;
    }
    .box{
      background:#fff;
      border-radius:18px;
      padding:16px;
      border:4px solid rgba(0,0,0,.75);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      color:#111;
    }
    .label{
      text-align:center;
      font-weight:800;
      font-size:20px;
      margin-bottom:10px;
    }
    input{
      width:100%;
      padding:14px 14px;
      font-size:20px;
      font-weight:800;
      text-align:center;
      letter-spacing:1px;
      border-radius:14px;
      border:3px solid rgba(0,0,0,.35);
      outline:none;
    }
    input::placeholder{letter-spacing:1px}
    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:14px;
      border:3px solid rgba(0,0,0,.55);
      background: linear-gradient(180deg, var(--yellow1), var(--yellow2));
      font-size:24px;
      font-weight:900;
      color:#0b2f74;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      font-weight:800;
      text-align:center;
      display:none;
      border:2px solid rgba(0,0,0,.15);
    }
    .msg.err{display:block; background:#ffe7e7; color:#b30000}
    .msg.ok{display:block; background:#e9fff1; color:#0c7a2a}
    .msg.wait{display:block; background:#fff7d9; color:#7a5b00}
    .footer{
      margin-top:14px;
      text-align:center;
      font-size:13px;
      opacity:.9;
      color:rgba(255,255,255,.9);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ✅ اكتب الاسم كما هو عندك بالضبط -->
    <img class="logo" src="logo.PNG" alt="صندوق المسابقات">

    <h1>تفعيل اللعبة</h1>

    <div class="box">
      <div class="label">أدخل كود التفعيل</div>
      <input id="code" autocomplete="off" inputmode="latin" placeholder="SNDQ-XXXX-XXXX-XXXX" />
      <button id="btn" class="btn">تفعيل</button>

      <div id="m" class="msg"></div>
    </div>

    <div class="footer">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
  </div>

<script>
  // ✅ رابط /exec الجديد اللي عطيتني
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyL--KkyP4HSjaArHWxG5nJQ4fe5ANCL2rTUJZIKWR5ZzyClJUNaTVa2O1kkgNfB2doqg/exec";

  // ✅ بعد التفعيل يروح هنا
  const NEXT_PAGE = "index.html";

  const LS_OK = "SNDQ_ACTIVATED_OK";
  const LS_DV = "SNDQ_DEVICE_KEY";

  const $ = (id)=>document.getElementById(id);
  const codeEl = $("code");
  const btn = $("btn");
  const msg = $("m");

  function show(type, text){
    msg.className = "msg " + type;
    msg.textContent = text;
  }

  function getDeviceKey(){
    let k = localStorage.getItem(LS_DV);
    if (k) return k;
    // uuid بسيط
    k = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
    localStorage.setItem(LS_DV, k);
    return k;
  }

  function normalizeCode(v){
    return (v||"")
      .toUpperCase()
      .replace(/\s+/g,"")
      .replace(/[^A-Z0-9-]/g,"")
      .trim();
  }

  function alreadyActivated(){
    return localStorage.getItem(LS_OK) === "1";
  }

  function goNext(){
    location.replace(NEXT_PAGE);
  }

  // ✅ لو الجهاز مفعل من قبل — دخله مباشرة
  if (alreadyActivated()){
    goNext();
  }

  // JSONP helper
  function jsonp(url, cbName){
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      const t = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 15000);

      function cleanup(){
        clearTimeout(t);
        if (s.parentNode) s.parentNode.removeChild(s);
        try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("network_error")); };
      s.src = url;
      document.body.appendChild(s);
    });
  }

  async function activate(){
    const code = normalizeCode(codeEl.value);
    if (!code || code.length < 10){
      show("err","اكتب كود صحيح.");
      return;
    }

    btn.disabled = true;
    show("wait","جاري التحقق من الكود...");

    const device = getDeviceKey();
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*9999);
    const url =
      SCRIPT_URL +
      "?code=" + encodeURIComponent(code) +
      "&device=" + encodeURIComponent(device) +
      "&callback=" + encodeURIComponent(cb) +
      "&_=" + Date.now();

    try{
      const res = await jsonp(url, cb);

      if (res && res.ok && res.activated){
        localStorage.setItem(LS_OK, "1");
        show("ok","✅ تم التفعيل");
        setTimeout(goNext, 600);
      } else {
        const err = (res && res.error) ? res.error : "unknown";
        if (err === "code_not_found") show("err","❌ الكود غير موجود.");
        else if (err === "code_used_on_another_device") show("err","❌ الكود مستخدم على جهاز آخر.");
        else if (err === "missing_code" || err === "missing_device") show("err","❌ بيانات ناقصة.");
        else show("err","❌ تعذر التفعيل. ("+ err +")");
      }
    }catch(e){
      show("err","❌ تعذر التحقق الآن. تأكد من رابط السكربت /exec والإنترنت.");
    }finally{
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", activate);
  codeEl.addEventListener("input", ()=>{ msg.style.display="none"; msg.className="msg"; });
  codeEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") activate(); });
</script>
</body>
</html>
