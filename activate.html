<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>تفعيل اللعبة</title>
  <style>
    :root{
      --bg:#ece6d7;
      --frame:#3f5a2a;
      --card:#f7f3ea;
      --card2:#e8e1cf;
      --text:#111;
      --muted:#6b6b6b;
      --yellow:#f4c400;
      --danger:#d66;
      --dangerBg:#f3d7d4;
      --ok:#2f8f4e;
      --okBg:#d9f0e1;
      --shadow:0 10px 26px rgba(0,0,0,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font-family: Arial, sans-serif;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 14px;
    }
    .wrap{
      width:min(520px, 100%);
      border:4px solid var(--frame);
      border-radius:26px;
      background:rgba(255,255,255,.35);
      padding:22px 16px 18px;
      box-shadow:var(--shadow);
      position:relative;
    }
    .logo{
      display:flex;
      justify-content:center;
      margin-top:2px;
      margin-bottom:16px;
    }
    .logo img{
      width:120px;
      height:auto;
      object-fit:contain;
    }
    .title{
      background:#fff;
      border:3px solid #000;
      border-radius:16px;
      padding:16px 14px;
      text-align:center;
      font-size:28px;
      font-weight:800;
      box-shadow:0 6px 0 rgba(0,0,0,.15);
      margin:6px auto 18px;
    }
    .panel{
      background:var(--card2);
      border-radius:18px;
      padding:14px;
    }
    .card{
      background:var(--card);
      border:3px solid #000;
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 22px rgba(0,0,0,.12);
    }
    .label{
      font-size:18px;
      font-weight:800;
      margin:4px 2px 10px;
      text-align:right;
    }
    .input{
      width:100%;
      border:2px solid #c9c9c9;
      border-radius:12px;
      padding:14px 12px;
      font-size:18px;
      outline:none;
      background:#fff;
      direction:ltr;
      text-align:left;
    }
    .btn{
      width:100%;
      margin-top:12px;
      padding:14px 12px;
      font-size:22px;
      font-weight:900;
      border-radius:14px;
      border:3px solid #000;
      background:var(--yellow);
      cursor:pointer;
      box-shadow:0 6px 0 rgba(0,0,0,.15);
    }
    .btn:active{ transform: translateY(2px); box-shadow:0 4px 0 rgba(0,0,0,.15); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      font-weight:800;
      text-align:center;
      display:none;
    }
    .msg.err{ background:var(--dangerBg); color:#7a1d1d; border:2px solid rgba(214,102,102,.7); }
    .msg.ok{ background:var(--okBg); color:#0f4d27; border:2px solid rgba(47,143,78,.45); }
    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
      font-weight:700;
    }
    .foot{
      margin-top:16px;
      text-align:center;
      font-size:12px;
      color:#666;
      font-weight:700;
    }
    .spinner{
      display:inline-block;
      width:18px;height:18px;
      border:3px solid rgba(0,0,0,.2);
      border-top-color:rgba(0,0,0,.75);
      border-radius:50%;
      animation:spin 1s linear infinite;
      vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin{ to{transform:rotate(360deg)} }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="logo">
      <img src="logo.PNG" alt="logo" />
    </div>

    <div class="title">تفعيل اللعبة</div>

    <div class="panel">
      <div class="card">
        <div class="label">أدخل كود اللعبة</div>
        <input id="codeInput" class="input" placeholder="SNDQ-XXXX-XXXX-XXXX" autocomplete="off" />

        <button id="actBtn" class="btn">تفعيل</button>

        <div id="msgBox" class="msg"></div>

        <div class="hint">بعد التفعيل سيتم ربط الكود بهذا الجهاز.</div>
      </div>
    </div>

    <div class="foot">© صندوق المسابقات</div>
  </div>

<script>
/** ✅ رابط سكربت اللعبة الجديدة (Web App /exec) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXnZYgiPTcDwslQHiuukG0VXETXrnKbwUMS1q3BF601pEuOY2vutCf7TkL1SpgfoVnSA/exec";

/** مفاتيح التخزين */
const LS_OK = "SNDQ_ACTIVATED_khamn_alsora";
const LS_CODE = "SNDQ_CODE_khamn_alsora";
const LS_DEVICE = "SNDQ_DEVICE_khamn_alsora";

const codeInput = document.getElementById("codeInput");
const actBtn = document.getElementById("actBtn");
const msgBox = document.getElementById("msgBox");

/** إذا الجهاز مفعّل مسبقاً -> روح للرئيسية */
if (localStorage.getItem(LS_OK) === "1") {
  window.location.replace("index.html");
}

/** جهاز ثابت لهذا المتصفح */
function getDeviceKey(){
  let k = localStorage.getItem(LS_DEVICE);
  if (!k) {
    k = "DEV-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    localStorage.setItem(LS_DEVICE, k);
  }
  return k;
}

function normalizeCode(v){
  return String(v || "")
    .trim()
    .toUpperCase()
    .replace(/[–—−]/g, "-")   // أي شرطة غريبة -> -
    .replace(/\s+/g, "");     // إزالة أي مسافات داخلية
}

function setMsg(type, text){
  msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
  msgBox.style.display = "block";
  msgBox.textContent = text;
}

function parseJsonp(text){
  // يستقبل: callback({...})
  const t = String(text || "").trim();
  const a = t.indexOf("(");
  const b = t.lastIndexOf(")");
  if (a !== -1 && b !== -1 && b > a) {
    const inside = t.slice(a+1, b);
    return JSON.parse(inside);
  }
  // إذا رجع JSON مباشر
  return JSON.parse(t);
}

function setLoading(on){
  if (on){
    actBtn.disabled = true;
    actBtn.innerHTML = `<span class="spinner"></span> جاري التفعيل...`;
  } else {
    actBtn.disabled = false;
    actBtn.textContent = "تفعيل";
  }
}

actBtn.addEventListener("click", async () => {
  msgBox.style.display = "none";

  const code = normalizeCode(codeInput.value);
  if (!code) return setMsg("err", "اكتب الكود أولاً.");

  const device = getDeviceKey();

  setLoading(true);

  try{
    const url =
      SCRIPT_URL
      + "?code=" + encodeURIComponent(code)
      + "&device=" + encodeURIComponent(device)
      + "&cb=callback"; // سكربتك يلفّ الرد بـ callback(...)

    const res = await fetch(url, { cache: "no-store" });
    const text = await res.text();
    const data = parseJsonp(text);

    if (data && data.ok) {
      localStorage.setItem(LS_OK, "1");
      localStorage.setItem(LS_CODE, code);
      setMsg("ok", "تم التفعيل ✅ جاري نقلك للعبة...");
      setTimeout(() => window.location.href = "index.html", 700);
      return;
    }

    // رسائل مفهومة
    const msg = (data && data.msg) ? data.msg : "فشل التفعيل.";
    setMsg("err", msg);

  }catch(e){
    setMsg("err", "صار خطأ بالاتصال. جرّب مرة ثانية.");
  }finally{
    setLoading(false);
  }
});

// Enter لتفعيل
codeInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") actBtn.click();
});
</script>

</body>
</html>
