<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>تفعيل لعبة تخمين الصور</title>
  <style>
    :root{
      --bg1:#1f4fa3;
      --bg2:#173f86;
      --card:rgba(255,255,255,.16);
      --card2:rgba(255,255,255,.10);
      --text:#ffffff;
      --dark:#0f172a;
      --yellow:#f4c400;
      --yellow2:#f6d55a;
      --danger:#ff3b30;
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Arial;
      background:
        radial-gradient(1200px 800px at 50% 30%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
    }
    .wrap{
      width:min(520px, 92vw);
      background:var(--card);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      padding:22px 18px 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .inner{
      background:var(--card2);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:18px 14px;
    }
    .logo{
      width:72px;
      height:72px;
      object-fit:contain;
      display:block;
      margin:0 auto 10px;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
    h1{
      margin:4px 0 14px;
      text-align:center;
      font-size:34px;
      line-height:1.1;
      font-weight:900;
      letter-spacing:.2px;
    }
    .card{
      margin:0 auto;
      width:min(430px, 100%);
      background:#fff;
      color:#111;
      border-radius:16px;
      border:3px solid rgba(0,0,0,.75);
      box-shadow: 0 10px 0 rgba(0,0,0,.25);
      padding:14px;
    }
    .label{
      text-align:center;
      font-size:22px;
      font-weight:900;
      margin:2px 0 10px;
    }
    input{
      width:100%;
      height:58px;
      font-size:22px;
      text-align:center;
      border-radius:12px;
      border:3px solid rgba(0,0,0,.25);
      outline:none;
      font-weight:900;
      letter-spacing:1px;
    }
    input::placeholder{letter-spacing:0;font-weight:700}
    .btn{
      width:100%;
      margin-top:12px;
      height:62px;
      border-radius:12px;
      border:3px solid rgba(0,0,0,.45);
      background: linear-gradient(180deg, var(--yellow2), var(--yellow));
      font-size:28px;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.25);
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .msg{
      margin-top:12px;
      border-radius:12px;
      padding:12px 12px;
      font-weight:900;
      text-align:center;
      display:none;
    }
    .msg.err{display:block;background:rgba(255,59,48,.12);border:1px solid rgba(255,59,48,.35);color:#b91c1c}
    .msg.ok{display:block;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#166534}
    .small{
      margin-top:10px;
      text-align:center;
      opacity:.8;
      font-weight:700;
      font-size:13px;
    }
    .spin{
      display:inline-block;
      width:16px;height:16px;
      border-radius:50%;
      border:2px solid rgba(0,0,0,.25);
      border-top-color: rgba(0,0,0,.8);
      animation: s 0.8s linear infinite;
      vertical-align:middle;
      margin-left:8px;
    }
    @keyframes s{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="inner">
      <img class="logo" src="logo.PNG" alt="صندوق المسابقات" onerror="this.style.display='none'">
      <h1>تفعيل لعبة تخمين الصور</h1>

      <div class="card">
        <div class="label">أدخل كود التفعيل</div>
        <input id="code" placeholder="SNDQ-XXXX-XXXX-XXXX" autocomplete="off" autocapitalize="characters" />
        <button id="btn" class="btn">تفعيل</button>
        <div id="msg" class="msg"></div>
      </div>

      <div class="small">© جميع الحقوق محفوظة لمتجر صندوق المسابقات</div>
    </div>
  </div>

  <script>
    // ✅ رابط سكربتك (الـ /exec)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyL--KkyP4HSjaArHWxG5nJQ4fe5ANCL2rTUJZIKWR5ZzyClJUNaTVa2O1kkgNfB2doqg/exec";

    // ✅ صفحة اللعبة بعد التفعيل (غيّرها لو لعبتك اسمها غير index.html)
    const GAME_URL = "index.html";

    const LS_ACT = "sandooq_activation_ok_v1";
    const LS_DEV = "sandooq_device_key_v1";
    const LS_CODE = "sandooq_code_v1";

    const $code = document.getElementById("code");
    const $btn  = document.getElementById("btn");
    const $msg  = document.getElementById("msg");

    function setMsg(type, text){
      $msg.className = "msg " + (type === "ok" ? "ok" : "err");
      $msg.textContent = text;
      $msg.style.display = "block";
    }
    function clearMsg(){
      $msg.style.display = "none";
      $msg.textContent = "";
      $msg.className = "msg";
    }

    function normalizeCode(v){
      return (v || "")
        .toUpperCase()
        .replace(/[^A-Z0-9-]/g, "")
        .replace(/\s+/g, "")
        .trim();
    }

    function getDeviceKey(){
      let k = localStorage.getItem(LS_DEV);
      if (k) return k;
      // UUID بسيط (بدون اعتماد على crypto.randomUUID عشان التوافق)
      k = "dev-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,10);
      localStorage.setItem(LS_DEV, k);
      return k;
    }

    function redirectToGame(){
      window.location.replace(GAME_URL);
    }

    // ✅ إذا الجهاز مفعل سابقاً -> يدخل اللعبة مباشرة
    if (localStorage.getItem(LS_ACT) === "1") {
      redirectToGame();
    }

    $code.addEventListener("input", () => {
      $code.value = normalizeCode($code.value);
    });

    $btn.addEventListener("click", async () => {
      clearMsg();

      const code = normalizeCode($code.value);
      if (!code || code.length < 8) {
        setMsg("err", "اكتب كود صحيح.");
        return;
      }

      $btn.disabled = true;
      const old = $btn.textContent;
      $btn.innerHTML = 'جاري التحقق<span class="spin"></span>';

      try{
        const deviceKey = getDeviceKey();

        // ✅ مهم جداً: GET فقط بدون headers عشان ما يصير CORS على iPhone
        const url =
          SCRIPT_URL
          + "?action=activate"
          + "&code=" + encodeURIComponent(code)
          + "&device=" + encodeURIComponent(deviceKey)
          + "&t=" + Date.now();

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 12000);

        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          signal: controller.signal
        });

        clearTimeout(timer);

        const text = await res.text();

        let data;
        try { data = JSON.parse(text); }
        catch(e){
          // لو رجّع HTML بالغلط أو أي شيء غير JSON
          throw new Error("رد السكربت غير مفهوم. تأكد أن الرابط /exec صحيح.");
        }

        if (!data || data.ok !== true) {
          const msg =
            data && data.error === "NOT_FOUND" ? "الكود غير موجود." :
            data && data.error === "USED" ? "هذا الكود مستخدم على جهاز آخر." :
            (data && data.message) ? data.message :
            "تعذر التحقق الآن. تأكد من رابط السكربت /exec.";
          setMsg("err", msg);
          return;
        }

        // ✅ نجاح
        localStorage.setItem(LS_ACT, "1");
        localStorage.setItem(LS_CODE, code);

        setMsg("ok", "تم التفعيل ✅ جاري الدخول للعبة...");
        setTimeout(redirectToGame, 600);

      }catch(err){
        const m =
          (err && err.name === "AbortError") ? "انتهت مهلة الاتصال. جرّب مرة ثانية." :
          "تعذر التحقق الآن. تأكد من الإنترنت ورابط السكربت /exec.";
        setMsg("err", m);
      }finally{
        $btn.disabled = false;
        $btn.textContent = old;
      }
    });
  </script>
</body>
</html>
