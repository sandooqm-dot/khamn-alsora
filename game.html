<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ØªØ®Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ± - Ø§Ù„Ù„Ø¹Ø¨</title>

  <style>
    :root{
      --page:#7a4a93;
      --panel:#7a4a93;

      --black:#000;
      --white:#fff;

      --btnYellow:#f4c400;
      --btnYellow2:#ffd35c;

      --btnGreen:#11c064;
      --btnGreen2:#0fb05b;

      --muted: rgba(255,255,255,.85);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: var(--page);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px 14px calc(18px + env(safe-area-inset-bottom));
      color:var(--white);
    }

    .outer{
      width:min(720px, 96vw);
      min-height: min(980px, 92vh);
      background: var(--panel);
      border-radius: 42px;
      padding: 22px 18px 18px;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .logo{
      position:absolute;
      top: 16px;
      left: 16px;
      width: 118px;
      height:auto;
      pointer-events:none;
      user-select:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
      z-index: 5;
    }

    .title{
      text-align:center;
      font-size: clamp(40px, 7.5vw, 64px);
      font-weight: 1000;
      margin: 96px 0 6px;
      color:#fff;
      text-shadow:
        -2px -2px 0 rgba(0,0,0,.35),
         2px -2px 0 rgba(0,0,0,.35),
        -2px  2px 0 rgba(0,0,0,.35),
         2px  2px 0 rgba(0,0,0,.35),
         0px  8px 0 rgba(0,0,0,.18);
      white-space:nowrap;
    }

    .bigNamePill{
      margin: 6px auto 8px;
      width: min(520px, 92%);
      text-align:center;
      border-radius: 999px;
      border: 5px solid rgba(0,0,0,.90);
      background: radial-gradient(700px 220px at 50% 10%, rgba(255,255,255,.08), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.28));
      box-shadow: 0 14px 0 rgba(0,0,0,.18);
      padding: 12px 18px;
      font-size: 42px;
      font-weight: 1000;
      text-shadow: 0 4px 0 rgba(0,0,0,.22);
    }

    .photoBox{
      width: min(650px, 96%);
      margin: 0 auto;
      background: #fff;
      border-radius: 26px;
      min-height: 520px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      box-shadow: 0 24px 40px rgba(0,0,0,.20);
      cursor:pointer;
    }
    /* âœ… Ù„Ù…Ø§ ØªÙ†Ù‚ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©: ÙŠØµÙŠØ± Ø´ÙƒÙ„Ù‡Ø§ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø± */
    .photoBox.locked{
      cursor: default;
      opacity: .98;
    }

    .photoHint{
      position:absolute;
      inset:auto 14px auto 14px;
      text-align:center;
      color:#7a7a7a;
      font-weight: 1000;
      font-size: 34px;
      text-shadow: 0 6px 0 rgba(0,0,0,.08);
      user-select:none;
      pointer-events:none;
    }

    .previewImg{
      width:100%;
      height:100%;
      object-fit: contain;
      display:none;
      background:#fff;
    }

    .roundCenterWrap{
      display:none;
      justify-content:center;
      margin-top: 18px;
    }
    .roundBtn{
      border:none;
      cursor:pointer;
      border-radius: 18px;
      padding: 10px 18px;
      font-size: 18px;
      font-weight: 1000;
      border: 4px solid rgba(0,0,0,.90);
      box-shadow: 0 10px 0 rgba(0,0,0,.22);
      transform: translateY(0);
      transition: transform .06s ease, opacity .15s ease;
      background: linear-gradient(180deg, var(--btnGreen), var(--btnGreen2));
      color:#fff;
      text-shadow: 0 3px 0 rgba(0,0,0,.28);
      white-space:nowrap;
      min-width: 170px;
    }
    .roundBtn:active{transform: translateY(3px)}
    .roundBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform: translateY(0);
    }

    .bottomArea{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      margin-top: 8px;
    }

    .buyBtn{
      width: min(520px, 92%);
      border:none;
      cursor:pointer;
      border-radius: 22px;
      padding: 14px 18px;
      font-size: 34px;
      font-weight: 1000;
      border: 5px solid rgba(0,0,0,.90);
      background: linear-gradient(180deg, var(--btnYellow2), var(--btnYellow));
      color:#111;
      box-shadow: 0 14px 0 rgba(0,0,0,.22);
      transform: translateY(0);
      transition: transform .06s ease;
    }
    .buyBtn:active{transform: translateY(3px)}

    .footer{
      text-align:center;
      font-weight: 1000;
      font-size: 18px;
      white-space: nowrap;
      opacity:.95;
      margin-top: 6px;
    }

    .status{
      text-align:center;
      font-weight: 1000;
      color: var(--muted);
      font-size: 16px;
      min-height: 22px;
    }

    .homeIcon{
      position: fixed;
      left: 14px;
      bottom: calc(14px + env(safe-area-inset-bottom));
      width: 54px;
      height: 54px;
      border-radius: 16px;
      border: 4px solid rgba(0,0,0,.90);
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 0 rgba(0,0,0,.22);
      display:none;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index: 9998;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .homeIcon:active{transform: translateY(3px)}
    .homeIcon span{
      font-size: 26px;
      line-height: 1;
      color:#111;
      font-weight: 1000;
    }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.28);
      display:none;
      align-items:center; justify-content:center;
      padding: 20px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .pill{
      background: rgba(0,0,0,.58);
      border: 2px solid rgba(255,255,255,.18);
      color:#fff;
      padding: 14px 16px;
      border-radius: 14px;
      font-weight: 1000;
      text-align:center;
      width:min(420px, 92vw);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }

    @media (max-width: 520px){
      .bigNamePill{font-size: 38px}
      .photoBox{min-height: 430px}
      .photoHint{font-size: 28px}
      .buyBtn{font-size: 28px}
      .logo{width:108px}
    }
  </style>
</head>

<body>
  <div class="outer">
    <img class="logo" src="logo.PNG" alt="ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª" />

    <div class="title">Ù„Ø¹Ø¨Ø© ØªØ®Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±</div>

    <div class="bigNamePill" id="myNamePill">...</div>

    <div class="photoBox" id="photoBox" title="Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©">
      <div class="photoHint" id="photoHint">Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©</div>
      <img id="previewImg" class="previewImg" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©" />
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <div class="roundCenterWrap" id="roundCenterWrap">
      <button class="roundBtn" id="btnNewRound" type="button">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>

    <div class="status" id="statusText"></div>

    <div class="bottomArea">
      <button class="buyBtn" id="buyBtn" type="button">Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ø¶ØºØ· Ù‡Ù†Ø§</button>
      <div class="footer">Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…ØªØ¬Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</div>
    </div>
  </div>

  <div class="homeIcon" id="homeIcon" title="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
    <span>ğŸ </span>
  </div>

  <div class="overlay" id="overlay">
    <div class="pill" id="overlayText">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYxoP7QEy3ShH_KOTx19jqj3IbWGTEOd0",
      authDomain: "bara-alsalfah-eu.firebaseapp.com",
      projectId: "bara-alsalfah-eu",
      storageBucket: "bara-alsalfah-eu.firebasestorage.app",
      messagingSenderId: "657928540352",
      appId: "1:657928540352:web:dcf15096ac8501326e9d25",
      measurementId: "G-HKJGX94BJD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    function getParam(key){
      const u = new URL(location.href);
      return (u.searchParams.get(key) || "").trim();
    }
    function getRoomId(){
      return getParam("r") || getParam("room") || getParam("id");
    }
    function getRole(){
      const r = (getParam("role") || "").toLowerCase();
      return (r === "host") ? "host" : "player";
    }

    const roomId = getRoomId();
    const role = getRole();
    const pid  = getParam("pid");

    const myNamePill = $("myNamePill");
    const photoBox = $("photoBox");
    const fileInput = $("fileInput");
    const previewImg = $("previewImg");
    const photoHint = $("photoHint");
    const statusText = $("statusText");

    const buyBtn = $("buyBtn");
    const roundCenterWrap = $("roundCenterWrap");
    const btnNewRound = $("btnNewRound");
    const homeIcon = $("homeIcon");

    // âœ… Ù‚ÙÙ„/ÙØªØ­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø©
    let imageLocked = false;
    function lockImage(){
      imageLocked = true;
      photoBox.classList.add("locked");
      photoBox.title = "";
    }
    function unlockImage(){
      imageLocked = false;
      photoBox.classList.remove("locked");
      photoBox.title = "Ø§Ø¶ØºØ· Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©";
    }

    function showOverlay(msg){
      $("overlayText").textContent = msg || "Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦";
      $("overlay").classList.add("show");
    }
    function hideOverlay(){
      $("overlay").classList.remove("show");
    }

    buyBtn.addEventListener("click", () => {
      window.open("https://sandooq-m.com", "_blank", "noopener,noreferrer");
    });

    if(role === "host"){
      roundCenterWrap.style.display = "flex";
      homeIcon.style.display = "flex";
      buyBtn.style.display = "none";
    }

    function clearLocalImage(){
      previewImg.src = "";
      previewImg.style.display = "none";
      photoHint.style.display = "block";
      fileInput.value = "";
      statusText.textContent = "";
      // âœ… Ù…Ø¹ Ø¨Ø¯Ø§ÙŠØ© Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ù†ÙØªØ­ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©
      unlockImage();
    }

    photoBox.addEventListener("click", () => {
      if(imageLocked) return;        // âœ… Ù…Ù…Ù†ÙˆØ¹ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      fileInput.click();
    });

    fileInput.addEventListener("change", () => {
      if(imageLocked) return;

      const f = fileInput.files && fileInput.files[0];
      if(!f) return;

      if(!f.type.startsWith("image/")){
        statusText.textContent = "âš ï¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø© ÙÙ‚Ø·";
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = String(reader.result || "");
        previewImg.style.display = "block";
        photoHint.style.display = "none";
        statusText.textContent = "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·)";
        // âœ… Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø±: Ù†Ù‚ÙÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        lockImage();
      };
      reader.readAsDataURL(f);
    });

    if(!roomId){
      statusText.textContent = "âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· Ù†Ø§Ù‚Øµ (Ù…Ø§ ÙÙŠÙ‡ Ø±Ù‚Ù… ØºØ±ÙØ©).";
      photoBox.style.pointerEvents = "none";
      photoBox.style.opacity = ".6";
      if(role === "host"){
        btnNewRound.disabled = true;
      }
    }

    const roomRef = roomId ? doc(db, "khamnRooms", roomId) : null;

    let unsub = null;
    let currentRoundId = null;

    function pickPlayerName(data){
      const arr = Array.isArray(data?.playersArr) ? data.playersArr : [];
      if(pid && arr.length){
        const me = arr.find(x => x && x.id === pid && (x.name || "").trim());
        if(me) return String(me.name).trim();
      }
      if((data?.player2Name || "").trim()) return String(data.player2Name).trim();

      const host = String(data?.hostName || "").trim();
      const last = [...arr].reverse().find(x => x && (x.name || "").trim() && String(x.name).trim() !== host);
      if(last) return String(last.name).trim();

      return "Ø§Ù„Ù„Ø§Ø¹Ø¨";
    }

    function renderMyName(data){
      const host = String(data?.hostName || "").trim() || "Ø§Ù„Ù…Ù‚Ø¯Ù…";
      const player = pickPlayerName(data);
      myNamePill.textContent = (role === "host") ? host : player;
    }

    async function ensureRoomDoc(){
      if(!roomRef) return false;

      const snap = await getDoc(roomRef);
      if(!snap.exists()){
        await setDoc(roomRef, {
          roomId,
          createdAt: serverTimestamp(),
          hostName: "",
          player2Name: "",
          status: "lobby",
          gameStarted: false,
          startedAt: null,
          roundId: String(Date.now())
        }, { merge:true });
      }
      return true;
    }

    function listenRoom(){
      unsub?.();
      unsub = onSnapshot(roomRef, (snap) => {
        if(!snap.exists()){
          statusText.textContent = "âš ï¸ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.";
          return;
        }

        const data = snap.data() || {};
        renderMyName(data);

        const rid = String(data.roundId || "");
        if(rid && currentRoundId !== rid){
          currentRoundId = rid;
          clearLocalImage();
          statusText.textContent = "ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯Ø£Øª";
          setTimeout(()=>{ if(statusText.textContent.includes("Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©")) statusText.textContent=""; }, 1200);
        }
      });
    }

    btnNewRound?.addEventListener("click", async () => {
      if(role !== "host" || !roomRef) return;
      showOverlay("Ø¬Ø§Ø±Ù Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©â€¦");
      try{
        await updateDoc(roomRef, {
          roundId: String(Date.now()),
          roundStartedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
      }catch(e){
        await setDoc(roomRef, {
          roundId: String(Date.now()),
          roundStartedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });
      }
      hideOverlay();
    });

    homeIcon?.addEventListener("click", async () => {
      if(role !== "host") return;

      showOverlay("Ø¬Ø§Ø±Ù Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©â€¦");

      try{
        if(roomRef){
          await setDoc(roomRef, {
            player2Name: "",
            playersArr: [],
            readyIds: [],
            status: "lobby",
            gameStarted: false,
            startedAt: null,
            roundId: String(Date.now()),
            updatedAt: serverTimestamp()
          }, { merge:true });
        }
      }catch(e){}

      try{ sessionStorage.removeItem("khamn_roomId"); }catch(e){}

      // âœ… ÙØªØ­ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ùˆ Ø±Ø¬Ø¹
      unlockImage();

      hideOverlay();
      location.href = "index.html";
    });

    (async () => {
      if(!roomRef) return;
      showOverlay("Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦");
      await ensureRoomDoc();
      listenRoom();
      hideOverlay();
    })();

    window.addEventListener("beforeunload", () => {
      unsub?.();
    });
  </script>
</body>
</html>

<!-- Ø§Ø³Ù… Ø§Ù„Ù†Ø³Ø®Ø©: game.html (ØªØ®Ù…ÙŠÙ† Ø§Ù„ØµÙˆØ±) â€“ Ø¥ØµØ¯Ø§Ø± 3 -->
